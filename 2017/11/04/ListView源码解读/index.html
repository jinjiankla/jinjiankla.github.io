<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="RTFSC (Read the fucking source code )," />





  <link rel="alternate" href="/atom.xml" title="Desire" type="application/atom+xml" />






<meta name="description" content="ListView的测量onMeasure12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182/** *   onMeasure four st">
<meta name="keywords" content="RTFSC (Read the fucking source code )">
<meta property="og:type" content="article">
<meta property="og:title" content="ListView源码解读">
<meta property="og:url" content="http://jinjian.info/2017/11/04/ListView源码解读/index.html">
<meta property="og:site_name" content="Desire">
<meta property="og:description" content="ListView的测量onMeasure12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182/** *   onMeasure four st">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://jinjian.info/images/ListView_RecycleBin.png">
<meta property="og:image" content="http://jinjian.info/images/ListView_Struct.png">
<meta property="og:updated_time" content="2017-12-23T19:39:18.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ListView源码解读">
<meta name="twitter:description" content="ListView的测量onMeasure12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182/** *   onMeasure four st">
<meta name="twitter:image" content="http://jinjian.info/images/ListView_RecycleBin.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://jinjian.info/2017/11/04/ListView源码解读/"/>





  <title>ListView源码解读 | Desire</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ddb5ad830b0accecaab2b551afd8c824";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Desire</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jinjian.info/2017/11/04/ListView源码解读/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jinjian">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_logo.svg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Desire">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">ListView源码解读</h1>
        

        <div class="post-meta">
         
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-04T00:00:00+08:00">
                2017-11-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/读别人的源码，涨自己的智慧/" itemprop="url" rel="index">
                    <span itemprop="name">读别人的源码，涨自己的智慧</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

  


          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  7,805字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  47分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="ListView的测量"><a href="#ListView的测量" class="headerlink" title="ListView的测量"></a>ListView的测量</h2><h3 id="onMeasure"><a href="#onMeasure" class="headerlink" title="onMeasure"></a>onMeasure</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *   onMeasure four step</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   1. getWidthMode and getWidthSize etc.</span></span><br><span class="line"><span class="comment"> *   2. widthSize if(unspcified)</span></span><br><span class="line"><span class="comment"> *       use (position of 0' child width + paddingRight + paddingLeft + scrollBarWidth)</span></span><br><span class="line"><span class="comment"> *      else</span></span><br><span class="line"><span class="comment"> *       modify measureState by childSate</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   3.heightSize if(unspecified)</span></span><br><span class="line"><span class="comment"> *         use(0'child height +paddingBottom+paddingTop+verticalScrollPadding)</span></span><br><span class="line"><span class="comment"> *      else if(At_Most)</span></span><br><span class="line"><span class="comment"> *         use the givend heightSize as max and compared with the inclusive size of children,</span></span><br><span class="line"><span class="comment"> *      also should add paddings</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   4.setMeasuredDimension()</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> widthMeasureSpec</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> heightMeasureSpec</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Sets up mListPadding by view's Padding</span></span><br><span class="line">    <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> widthMode = MeasureSpec.getMode(widthMeasureSpec);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> heightMode = MeasureSpec.getMode(heightMeasureSpec);</span><br><span class="line">    <span class="keyword">int</span> widthSize = MeasureSpec.getSize(widthMeasureSpec);</span><br><span class="line">    <span class="keyword">int</span> heightSize = MeasureSpec.getSize(heightMeasureSpec);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> childWidth = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> childHeight = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> childState = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    mItemCount = mAdapter == <span class="keyword">null</span> ? <span class="number">0</span> : mAdapter.getCount();</span><br><span class="line">    <span class="keyword">if</span> (mItemCount &gt; <span class="number">0</span> &amp;&amp; (widthMode == MeasureSpec.UNSPECIFIED</span><br><span class="line">            || heightMode == MeasureSpec.UNSPECIFIED)) &#123;</span><br><span class="line">        <span class="keyword">final</span> View child = obtainView(<span class="number">0</span>, mIsScrap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Lay out child directly against the parent measure spec so that</span></span><br><span class="line">        <span class="comment">// we can obtain exected minimum width and height.</span></span><br><span class="line">        measureScrapChild(child, <span class="number">0</span>, widthMeasureSpec, heightSize);</span><br><span class="line"></span><br><span class="line">        childWidth = child.getMeasuredWidth();</span><br><span class="line">        childHeight = child.getMeasuredHeight();</span><br><span class="line">        childState = combineMeasuredStates(childState, child.getMeasuredState());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (recycleOnMeasure() &amp;&amp; mRecycler.shouldRecycleViewType(</span><br><span class="line">                ((LayoutParams) child.getLayoutParams()).viewType)) &#123;</span><br><span class="line">            mRecycler.addScrapView(child, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (widthMode == MeasureSpec.UNSPECIFIED) &#123;</span><br><span class="line">      <span class="comment">//use (position of 0' child width + paddingRight + paddingLeft + scrollBarWidth)</span></span><br><span class="line">        widthSize = mListPadding.left + mListPadding.right + childWidth +</span><br><span class="line">                getVerticalScrollbarWidth();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">//modify measureState by childSate</span></span><br><span class="line">        widthSize |= (childState &amp; MEASURED_STATE_MASK);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (heightMode == MeasureSpec.UNSPECIFIED) &#123;</span><br><span class="line">      <span class="comment">//use(0'child height +paddingBottom+paddingTop+verticalScrollPadding)</span></span><br><span class="line">        heightSize = mListPadding.top + mListPadding.bottom + childHeight +</span><br><span class="line">                getVerticalFadingEdgeLength() * <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (heightMode == MeasureSpec.AT_MOST) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> after first layout we should maybe start at the first visible position, not 0</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">// use the givend heightSize as max and compared with the inclusive size of children,</span></span><br><span class="line">      <span class="comment">// also should add paddings</span></span><br><span class="line">        heightSize = measureHeightOfChildren(widthMeasureSpec, <span class="number">0</span>, NO_POSITION, heightSize, -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//often here heightMode  AT_MOST or EXCACTLY</span></span><br><span class="line">    setMeasuredDimension(widthSize, heightSize);</span><br><span class="line"></span><br><span class="line">    mWidthMeasureSpec = widthMeasureSpec;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="measureHeightofChildren"><a href="#measureHeightofChildren" class="headerlink" title="measureHeightofChildren"></a>measureHeightofChildren</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Measures the height of the given range of children (inclusive) and</span></span><br><span class="line"><span class="comment">  * returns the height with this ListView's padding and divider heights</span></span><br><span class="line"><span class="comment">  * included. If maxHeight is provided, the measuring will stop when the</span></span><br><span class="line"><span class="comment">  * current height reaches maxHeight.</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> widthMeasureSpec The width measure spec to be given to a child's</span></span><br><span class="line"><span class="comment">  *            &#123;<span class="doctag">@link</span> View#measure(int, int)&#125;.</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> startPosition The position of the first child to be shown.</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> endPosition The (inclusive) position of the last child to be</span></span><br><span class="line"><span class="comment">  *            shown. Specify &#123;<span class="doctag">@link</span> #NO_POSITION&#125; if the last child should be</span></span><br><span class="line"><span class="comment">  *            the last available child from the adapter.</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> maxHeight The maximum height that will be returned (if all the</span></span><br><span class="line"><span class="comment">  *            children don't fit in this value, this value will be</span></span><br><span class="line"><span class="comment">  *            returned).</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> disallowPartialChildPosition In general, whether the returned</span></span><br><span class="line"><span class="comment">  *            height should only contain entire children. This is more</span></span><br><span class="line"><span class="comment">  *            powerful--it is the first inclusive position at which partial</span></span><br><span class="line"><span class="comment">  *            children will not be allowed. Example: it looks nice to have</span></span><br><span class="line"><span class="comment">  *            at least 3 completely visible children, and in portrait this</span></span><br><span class="line"><span class="comment">  *            will most likely fit; but in landscape there could be times</span></span><br><span class="line"><span class="comment">  *            when even 2 children can not be completely shown, so a value</span></span><br><span class="line"><span class="comment">  *            of 2 (remember, inclusive) would be good (assuming</span></span><br><span class="line"><span class="comment">  *            startPosition is 0).</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> The height of this ListView with the given children.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">measureHeightOfChildren</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> startPosition, <span class="keyword">int</span> endPosition,</span></span></span><br><span class="line"><span class="function"><span class="params">         <span class="keyword">int</span> maxHeight, <span class="keyword">int</span> disallowPartialChildPosition)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">final</span> ListAdapter adapter = mAdapter;</span><br><span class="line">     <span class="keyword">if</span> (adapter == <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">return</span> mListPadding.top + mListPadding.bottom;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// Include the padding of the list</span></span><br><span class="line">     <span class="keyword">int</span> returnedHeight = mListPadding.top + mListPadding.bottom;</span><br><span class="line">     <span class="keyword">final</span> <span class="keyword">int</span> dividerHeight = ((mDividerHeight &gt; <span class="number">0</span>) &amp;&amp; mDivider != <span class="keyword">null</span>) ? mDividerHeight : <span class="number">0</span>;</span><br><span class="line">     <span class="comment">// The previous height value that was less than maxHeight and contained</span></span><br><span class="line">     <span class="comment">// no partial children</span></span><br><span class="line">     <span class="keyword">int</span> prevHeightWithoutPartialChild = <span class="number">0</span>;</span><br><span class="line">     <span class="keyword">int</span> i;</span><br><span class="line">     View child;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// mItemCount - 1 since endPosition parameter is inclusive</span></span><br><span class="line">     endPosition = (endPosition == NO_POSITION) ? adapter.getCount() - <span class="number">1</span> : endPosition;</span><br><span class="line">     <span class="keyword">final</span> AbsListView.RecycleBin recycleBin = mRecycler;</span><br><span class="line">     <span class="keyword">final</span> <span class="keyword">boolean</span> recyle = recycleOnMeasure();</span><br><span class="line">     <span class="keyword">final</span> <span class="keyword">boolean</span>[] isScrap = mIsScrap;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">for</span> (i = startPosition; i &lt;= endPosition; ++i) &#123;</span><br><span class="line">       <span class="comment">//obtain view and add to the scrapList</span></span><br><span class="line">         child = obtainView(i, isScrap);</span><br><span class="line">       <span class="comment">//measure the child </span></span><br><span class="line">         measureScrapChild(child, i, widthMeasureSpec, maxHeight);</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">             <span class="comment">// Count the divider for all but one child</span></span><br><span class="line">             returnedHeight += dividerHeight;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Recycle the view before we possibly return from the method</span></span><br><span class="line">         <span class="keyword">if</span> (recyle &amp;&amp; recycleBin.shouldRecycleViewType(</span><br><span class="line">                 ((LayoutParams) child.getLayoutParams()).viewType)) &#123;</span><br><span class="line">             recycleBin.addScrapView(child, -<span class="number">1</span>);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         returnedHeight += child.getMeasuredHeight();</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (returnedHeight &gt;= maxHeight) &#123;</span><br><span class="line">             <span class="comment">// We went over, figure out which height to return.  If returnedHeight &gt; maxHeight,</span></span><br><span class="line">             <span class="comment">// then the i'th position did not fit completely.</span></span><br><span class="line">             <span class="keyword">return</span> (disallowPartialChildPosition &gt;= <span class="number">0</span>) <span class="comment">// Disallowing is enabled (&gt; -1)</span></span><br><span class="line">                         &amp;&amp; (i &gt; disallowPartialChildPosition) <span class="comment">// We've past the min pos</span></span><br><span class="line">                         &amp;&amp; (prevHeightWithoutPartialChild &gt; <span class="number">0</span>) <span class="comment">// We have a prev height</span></span><br><span class="line">                         &amp;&amp; (returnedHeight != maxHeight) <span class="comment">// i'th child did not fit completely</span></span><br><span class="line">                     ? prevHeightWithoutPartialChild</span><br><span class="line">                     : maxHeight;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> ((disallowPartialChildPosition &gt;= <span class="number">0</span>) &amp;&amp; (i &gt;= disallowPartialChildPosition)) &#123;</span><br><span class="line">             prevHeightWithoutPartialChild = returnedHeight;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// At this point, we went through the range of children, and they each</span></span><br><span class="line">     <span class="comment">// completely fit, so return the returnedHeight</span></span><br><span class="line">     <span class="keyword">return</span> returnedHeight;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h2 id="ListView的生成"><a href="#ListView的生成" class="headerlink" title="ListView的生成"></a>ListView的生成</h2><h3 id="一般流程"><a href="#一般流程" class="headerlink" title="一般流程"></a>一般流程</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">abslistView:onLayout-&gt;</span><br><span class="line">ListView:layoutChildren-&gt;</span><br><span class="line">ListView:fillFromTop-&gt;</span><br><span class="line">ListView:fillDown-&gt;</span><br><span class="line">ListView:makeAndAddView-&gt;</span><br><span class="line">mRecycler.getActiveView(position) <span class="function">or <span class="title">obtainView</span><span class="params">(position, mIsScrap)</span>［has adapter 的 getview］</span></span><br><span class="line"><span class="function">and then</span></span><br><span class="line"><span class="function"><span class="title">setupChild</span><span class="params">(child, position, y, flow, childrenLeft, selected, mIsScrap[<span class="number">0</span>])</span>［has addViewInLayout ］</span></span><br></pre></td></tr></table></figure>
<h4 id="onLayout"><a href="#onLayout" class="headerlink" title="onLayout"></a>onLayout</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Subclasses should NOT override this method but</span></span><br><span class="line"><span class="comment"> *  &#123;<span class="doctag">@link</span> #layoutChildren()&#125; instead.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onLayout(changed, l, t, r, b);</span><br><span class="line"></span><br><span class="line">    mInLayout = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = getChildCount();</span><br><span class="line">    <span class="keyword">if</span> (changed) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">            getChildAt(i).forceLayout();</span><br><span class="line">        &#125;</span><br><span class="line">        mRecycler.markChildrenDirty();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//here:diff from ListView to GrideView</span></span><br><span class="line">    layoutChildren();</span><br><span class="line">    mInLayout = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    mOverscrollMax = (b - t) / OVERSCROLL_LIMIT_DIVISOR;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Move somewhere sane. This doesn't belong in onLayout().</span></span><br><span class="line">    <span class="keyword">if</span> (mFastScroll != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mFastScroll.onItemCountChanged(getChildCount(), mItemCount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="layoutChildren"><a href="#layoutChildren" class="headerlink" title="layoutChildren"></a>layoutChildren</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  do with focus or aceessibility or other stuff style etc.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   1.IMPORTANT ROUTE:</span></span><br><span class="line"><span class="comment"> *   ListView:fillFromTop-&gt;</span></span><br><span class="line"><span class="comment"> *   ListView:fillDown-&gt;</span></span><br><span class="line"><span class="comment"> *   ListView:makeAndAddView-&gt;</span></span><br><span class="line"><span class="comment"> *   mRecycler.getActiveView(position) or obtainView(position, mIsScrap)［has adapter 的 getview］ and then setupChild(child, position, y, flow, childrenLeft, selected, mIsScrap[0])</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  // input startTop and startPos then to caculate</span></span><br><span class="line"><span class="comment"> *  while (List.top &gt; List.end)</span></span><br><span class="line"><span class="comment"> *  &#123;</span></span><br><span class="line"><span class="comment"> *  position +List.Top -&gt; nextChild'Bottom -&gt;nextChild'Bottom +divider height as next List.Top</span></span><br><span class="line"><span class="comment"> *  &#125;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  // also in setupChild() to add the views into view trees</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">layoutChildren</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> blockLayoutRequests = mBlockLayoutRequests;</span><br><span class="line">    <span class="keyword">if</span> (blockLayoutRequests) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mBlockLayoutRequests = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.layoutChildren();</span><br><span class="line"></span><br><span class="line">        invalidate();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mAdapter == <span class="keyword">null</span>) &#123;</span><br><span class="line">            resetList();</span><br><span class="line">            invokeOnItemScrollListener();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childrenTop = mListPadding.top;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childrenBottom = mBottom - mTop - mListPadding.bottom;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childCount = getChildCount();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> delta = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        View sel;</span><br><span class="line">        View oldSel = <span class="keyword">null</span>;</span><br><span class="line">        View oldFirst = <span class="keyword">null</span>;</span><br><span class="line">        View newSel = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Remember stuff we will need down below</span></span><br><span class="line">        <span class="keyword">switch</span> (mLayoutMode) &#123;</span><br><span class="line">        <span class="comment">//...........</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="comment">// Remember the previously selected view</span></span><br><span class="line">            index = mSelectedPosition - mFirstPosition;</span><br><span class="line">            <span class="keyword">if</span> (index &gt;= <span class="number">0</span> &amp;&amp; index &lt; childCount) &#123;</span><br><span class="line">                oldSel = getChildAt(index);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Remember the previous first child</span></span><br><span class="line">            oldFirst = getChildAt(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mNextSelectedPosition &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                delta = mNextSelectedPosition - mSelectedPosition;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Caution: newSel might be null</span></span><br><span class="line">            newSel = getChildAt(index + delta);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> dataChanged = mDataChanged;</span><br><span class="line">        <span class="keyword">if</span> (dataChanged) &#123;</span><br><span class="line">            handleDataChanged();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Handle the empty set by removing all views that are visible</span></span><br><span class="line">        <span class="comment">// and calling it a day</span></span><br><span class="line">        <span class="keyword">if</span> (mItemCount == <span class="number">0</span>) &#123;</span><br><span class="line">            resetList();</span><br><span class="line">            invokeOnItemScrollListener();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mItemCount != mAdapter.getCount()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The content of the adapter has changed but "</span></span><br><span class="line">                    + <span class="string">"ListView did not receive a notification. Make sure the content of "</span></span><br><span class="line">                    + <span class="string">"your adapter is not modified from a background thread, but only from "</span></span><br><span class="line">                    + <span class="string">"the UI thread. Make sure your adapter calls notifyDataSetChanged() "</span></span><br><span class="line">                    + <span class="string">"when its content changes. [in ListView("</span> + getId() + <span class="string">", "</span> + getClass()</span><br><span class="line">                    + <span class="string">") with Adapter("</span> + mAdapter.getClass() + <span class="string">")]"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        setSelectedPositionInt(mNextSelectedPosition);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//..................</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Pull all children into the RecycleBin.</span></span><br><span class="line">        <span class="comment">// These views will be reused if possible</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> firstPosition = mFirstPosition;</span><br><span class="line">        <span class="keyword">final</span> RecycleBin recycleBin = mRecycler;</span><br><span class="line">        <span class="keyword">if</span> (dataChanged) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">                recycleBin.addScrapView(getChildAt(i), firstPosition+i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            recycleBin.fillActiveViews(childCount, firstPosition);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Clear out old views</span></span><br><span class="line">        detachAllViewsFromParent();</span><br><span class="line">        recycleBin.removeSkippedScrap();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (mLayoutMode) &#123;</span><br><span class="line">        <span class="keyword">case</span> LAYOUT_SET_SELECTION:</span><br><span class="line">            <span class="keyword">if</span> (newSel != <span class="keyword">null</span>) &#123;</span><br><span class="line">                sel = fillFromSelection(newSel.getTop(), childrenTop, childrenBottom);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                sel = fillFromMiddle(childrenTop, childrenBottom);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> LAYOUT_SYNC:</span><br><span class="line">            sel = fillSpecific(mSyncPosition, mSpecificTop);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> LAYOUT_FORCE_BOTTOM:</span><br><span class="line">            sel = fillUp(mItemCount - <span class="number">1</span>, childrenBottom);</span><br><span class="line">            adjustViewsUpOrDown();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> LAYOUT_FORCE_TOP:</span><br><span class="line">            mFirstPosition = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">//Here:to fill the list..</span></span><br><span class="line">            sel = fillFromTop(childrenTop);</span><br><span class="line">         <span class="comment">//..................</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Flush any cached views that did not get reused above</span></span><br><span class="line">        recycleBin.scrapActiveViews();</span><br><span class="line"></span><br><span class="line">      <span class="comment">//.................</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Tell focus view we are done mucking with it, if it is still in</span></span><br><span class="line">        <span class="comment">// our view hierarchy.</span></span><br><span class="line">     <span class="comment">//............</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mItemCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            checkSelectionChanged();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        invokeOnItemScrollListener();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!blockLayoutRequests) &#123;</span><br><span class="line">            mBlockLayoutRequests = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="fillFromTop"><a href="#fillFromTop" class="headerlink" title="fillFromTop"></a>fillFromTop</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Fills the list from top to bottom, starting with mFirstPosition</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> nextTop The location where the top of the first item should be</span></span><br><span class="line"><span class="comment">  *        drawn</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> The view that is currently selected</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">private</span> View <span class="title">fillFromTop</span><span class="params">(<span class="keyword">int</span> nextTop)</span> </span>&#123;</span><br><span class="line">     mFirstPosition = Math.min(mFirstPosition, mSelectedPosition);</span><br><span class="line">     mFirstPosition = Math.min(mFirstPosition, mItemCount - <span class="number">1</span>);</span><br><span class="line">     <span class="keyword">if</span> (mFirstPosition &lt; <span class="number">0</span>) &#123;</span><br><span class="line">         mFirstPosition = <span class="number">0</span>;</span><br><span class="line">     &#125;</span><br><span class="line">   <span class="comment">// the first nextTop is listpadding.top</span></span><br><span class="line">     <span class="keyword">return</span> fillDown(mFirstPosition, nextTop);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h4 id="fillDown"><a href="#fillDown" class="headerlink" title="fillDown"></a>fillDown</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Fills the list from pos down to the end of the list view.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pos The first position to put in the list</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> nextTop The location where the top of the item associated with pos</span></span><br><span class="line"><span class="comment"> *        should be drawn</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> The view that is currently selected, if it happens to be in the</span></span><br><span class="line"><span class="comment"> *         range that we draw.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> View <span class="title">fillDown</span><span class="params">(<span class="keyword">int</span> pos, <span class="keyword">int</span> nextTop)</span> </span>&#123;</span><br><span class="line">    View selectedView = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> end = (mBottom - mTop);</span><br><span class="line">    <span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</span><br><span class="line">        end -= mListPadding.bottom;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">   <span class="comment">//the condition to break the while</span></span><br><span class="line">    <span class="keyword">while</span> (nextTop &lt; end &amp;&amp; pos &lt; mItemCount) &#123;</span><br><span class="line">        <span class="comment">// is this the selected item?</span></span><br><span class="line">        <span class="keyword">boolean</span> selected = pos == mSelectedPosition;</span><br><span class="line">        View child = makeAndAddView(pos, nextTop, <span class="keyword">true</span>, mListPadding.left, selected);</span><br><span class="line">       <span class="comment">// caculate the nextTop </span></span><br><span class="line">        nextTop = child.getBottom() + mDividerHeight;</span><br><span class="line">        <span class="keyword">if</span> (selected) &#123;</span><br><span class="line">            selectedView = child;</span><br><span class="line">        &#125;</span><br><span class="line">        pos++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setVisibleRangeHint(mFirstPosition, mFirstPosition + getChildCount() - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> selectedView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="makeAndAddView"><a href="#makeAndAddView" class="headerlink" title="makeAndAddView"></a>makeAndAddView</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Obtain the view and add it to our list of children. The view can be made</span></span><br><span class="line"><span class="comment">  * fresh, converted from an unused view, or used as is if it was in the</span></span><br><span class="line"><span class="comment">  * recycle bin.</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> position Logical position in the list</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> y Top or bottom edge of the view to add</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> flow If flow is true, align top edge to y. If false, align bottom</span></span><br><span class="line"><span class="comment">  *        edge to y.</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> childrenLeft Left edge where children should be positioned</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> selected Is this position selected?</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> View that was added</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">private</span> View <span class="title">makeAndAddView</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">int</span> y, <span class="keyword">boolean</span> flow, <span class="keyword">int</span> childrenLeft,</span></span></span><br><span class="line"><span class="function"><span class="params">         <span class="keyword">boolean</span> selected)</span> </span>&#123;</span><br><span class="line">     View child;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (!mDataChanged) &#123;</span><br><span class="line">         <span class="comment">// Try to use an existing view for this position</span></span><br><span class="line">         child = mRecycler.getActiveView(position);</span><br><span class="line">         <span class="keyword">if</span> (child != <span class="keyword">null</span>) &#123;</span><br><span class="line">             <span class="comment">// Found it -- we're using an existing child</span></span><br><span class="line">             <span class="comment">// This just needs to be positioned</span></span><br><span class="line">             setupChild(child, position, y, flow, childrenLeft, selected, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">             <span class="keyword">return</span> child;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// Make a new view for this position, or convert an unused view if possible</span></span><br><span class="line">     child = obtainView(position, mIsScrap);</span><br><span class="line"></span><br><span class="line">     <span class="comment">// This needs to be positioned and measured</span></span><br><span class="line">     setupChild(child, position, y, flow, childrenLeft, selected, mIsScrap[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> child;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h4 id="setupChild"><a href="#setupChild" class="headerlink" title="setupChild"></a>setupChild</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Add a view as a child and make sure it is measured (if necessary) and</span></span><br><span class="line"><span class="comment"> * positioned properly.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> child The view to add</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> position The position of this child</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> y The y position relative to which this view will be positioned</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> flowDown If true, align top edge to y. If false, align bottom</span></span><br><span class="line"><span class="comment"> *        edge to y.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> childrenLeft Left edge where children should be positioned</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> selected Is this position selected?</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> recycled Has this view been pulled from the recycle bin? If so it</span></span><br><span class="line"><span class="comment"> *        does not need to be remeasured.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setupChild</span><span class="params">(View child, <span class="keyword">int</span> position, <span class="keyword">int</span> y, <span class="keyword">boolean</span> flowDown, <span class="keyword">int</span> childrenLeft,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> selected, <span class="keyword">boolean</span> recycled)</span> </span>&#123;</span><br><span class="line">     <span class="comment">//.............</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((recycled &amp;&amp; !p.forceAdd) || (p.recycledHeaderFooter</span><br><span class="line">            &amp;&amp; p.viewType == AdapterView.ITEM_VIEW_TYPE_HEADER_OR_FOOTER)) &#123;</span><br><span class="line">        attachViewToParent(child, flowDown ? -<span class="number">1</span> : <span class="number">0</span>, p);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        p.forceAdd = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (p.viewType == AdapterView.ITEM_VIEW_TYPE_HEADER_OR_FOOTER) &#123;</span><br><span class="line">            p.recycledHeaderFooter = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">//HERE:</span></span><br><span class="line">        addViewInLayout(child, flowDown ? -<span class="number">1</span> : <span class="number">0</span>, p, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (updateChildSelected) &#123;</span><br><span class="line">        child.setSelected(isSelected);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (updateChildPressed) &#123;</span><br><span class="line">        child.setPressed(isPressed);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mChoiceMode != CHOICE_MODE_NONE &amp;&amp; mCheckStates != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (child <span class="keyword">instanceof</span> Checkable) &#123;</span><br><span class="line">            ((Checkable) child).setChecked(mCheckStates.get(position));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getContext().getApplicationInfo().targetSdkVersion</span><br><span class="line">                &gt;= android.os.Build.VERSION_CODES.HONEYCOMB) &#123;</span><br><span class="line">            child.setActivated(mCheckStates.get(position));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// reMeasure..........</span></span><br><span class="line">    <span class="keyword">if</span> (needToMeasure) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childWidthSpec = ViewGroup.getChildMeasureSpec(mWidthMeasureSpec,</span><br><span class="line">                mListPadding.left + mListPadding.right, p.width);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> lpHeight = p.height;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childHeightSpec;</span><br><span class="line">        <span class="keyword">if</span> (lpHeight &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            childHeightSpec = MeasureSpec.makeMeasureSpec(lpHeight, MeasureSpec.EXACTLY);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            childHeightSpec = MeasureSpec.makeSafeMeasureSpec(getMeasuredHeight(),</span><br><span class="line">                    MeasureSpec.UNSPECIFIED);</span><br><span class="line">        &#125;</span><br><span class="line">        child.measure(childWidthSpec, childHeightSpec);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        cleanupLayoutState(child);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> w = child.getMeasuredWidth();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> h = child.getMeasuredHeight();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childTop = flowDown ? y : y - h;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (needToMeasure) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childRight = childrenLeft + w;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childBottom = childTop + h;</span><br><span class="line">        child.layout(childrenLeft, childTop, childRight, childBottom);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        child.offsetLeftAndRight(childrenLeft - child.getLeft());</span><br><span class="line">        child.offsetTopAndBottom(childTop - child.getTop());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//........</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="addViewInLayout"><a href="#addViewInLayout" class="headerlink" title="addViewInLayout"></a>addViewInLayout</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Adds a view during layout. This is useful if in your onLayout() method,</span></span><br><span class="line"><span class="comment">     * you need to add more views (as does the list view for example).</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * If index is negative, it means put it at the end of the list.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> child the view to add to the group</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> index the index at which the child must be added or -1 to add last</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> params the layout parameters to associate with the child</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> preventRequestLayout if true, calling this method will not trigger a</span></span><br><span class="line"><span class="comment">     *        layout request on child</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true if the child was added, false otherwise</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">addViewInLayout</span><span class="params">(View child, <span class="keyword">int</span> index, LayoutParams params,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> preventRequestLayout)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Cannot add a null child view to a ViewGroup"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        child.mParent = <span class="keyword">null</span>;</span><br><span class="line">        addViewInner(child, index, params, preventRequestLayout);</span><br><span class="line">        child.mPrivateFlags = (child.mPrivateFlags &amp; ~PFLAG_DIRTY_MASK) | PFLAG_DRAWN;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*---------------Things to do ----------------</span></span><br><span class="line"><span class="comment">* addInArray</span></span><br><span class="line"><span class="comment">* assignPanrent</span></span><br><span class="line"><span class="comment">* requestFocus</span></span><br><span class="line"><span class="comment">* dispatchAttachInfo</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addViewInner</span><span class="params">(View child, <span class="keyword">int</span> index, LayoutParams params,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> preventRequestLayout)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line">        <span class="keyword">if</span> (!checkLayoutParams(params)) &#123;</span><br><span class="line">            params = generateLayoutParams(params);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (preventRequestLayout) &#123;</span><br><span class="line">            child.mLayoutParams = params;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            child.setLayoutParams(params);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            index = mChildrenCount;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        addInArray(child, index);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// tell our children</span></span><br><span class="line">        <span class="keyword">if</span> (preventRequestLayout) &#123;</span><br><span class="line">            child.assignParent(<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            child.mParent = <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (child.hasFocus()) &#123;</span><br><span class="line">            requestChildFocus(child, child.findFocus());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        AttachInfo ai = mAttachInfo;</span><br><span class="line">        <span class="keyword">if</span> (ai != <span class="keyword">null</span> &amp;&amp; (mGroupFlags &amp; FLAG_PREVENT_DISPATCH_ATTACHED_TO_WINDOW) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> lastKeepOn = ai.mKeepScreenOn;</span><br><span class="line">            ai.mKeepScreenOn = <span class="keyword">false</span>;</span><br><span class="line">            child.dispatchAttachedToWindow(mAttachInfo, (mViewFlags&amp;VISIBILITY_MASK));</span><br><span class="line">            <span class="keyword">if</span> (ai.mKeepScreenOn) &#123;</span><br><span class="line">                needGlobalAttributesUpdate(<span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ai.mKeepScreenOn = lastKeepOn;</span><br><span class="line">   <span class="comment">//.............</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="回收机制"><a href="#回收机制" class="headerlink" title="回收机制"></a>回收机制</h3><h4 id="RecycleBin"><a href="#RecycleBin" class="headerlink" title="RecycleBin"></a>RecycleBin</h4><h5 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">       The RecycleBin facilitates reuse of views across layouts. The RecycleBin has two levels of</span><br><span class="line">storage: ActiveViews and ScrapViews. ActiveViews are those views which were onscreen at the</span><br><span class="line">start of a layout. By construction, they are displaying current information. At the end of layout, all views in ActiveViews are demoted to ScrapViews. ScrapViews are old views that</span><br><span class="line">could potentially be used by the adapter to avoid allocating views unnecessarily.</span><br></pre></td></tr></table></figure>
<h5 id="关键参数"><a href="#关键参数" class="headerlink" title="关键参数"></a>关键参数</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The position of the first view stored in mActiveViews.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> mFirstActivePosition;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Views that were on screen at the start of layout. This array is populated at the start of layout, and at the end of layout all view in mActiveViews are moved to mScrapViews.Views in mActiveViews represent a contiguous range of Views, with position of the first view store in mFirstActivePosition.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> View[] mActiveViews = <span class="keyword">new</span> View[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Unsorted views that can be used by the adapter as a convert view.</span></span><br><span class="line"><span class="comment"> * eg: ArrayList&lt;View&gt;[TYPE1]=......</span></span><br><span class="line"><span class="comment"> *     ArrayList&lt;View&gt;[TYPE2]=......</span></span><br><span class="line"><span class="comment"> *     ArrayList&lt;View&gt;[TYPE3]=...... </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> ArrayList&lt;View&gt;[] mScrapViews;</span><br></pre></td></tr></table></figure>
<h5 id="关键方法"><a href="#关键方法" class="headerlink" title="关键方法"></a>关键方法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//usage:addToActiveViews</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> View <span class="title">retrieveFromScrap</span><span class="params">(ArrayList&lt;View&gt; scrapViews, <span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> size = scrapViews.size();</span><br><span class="line">            <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// See if we still have a view for this position or ID.</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">                    <span class="keyword">final</span> View view = scrapViews.get(i);</span><br><span class="line">                    <span class="keyword">final</span> AbsListView.LayoutParams params =</span><br><span class="line">                            (AbsListView.LayoutParams) view.getLayoutParams();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (mAdapterHasStableIds) &#123;</span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">long</span> id = mAdapter.getItemId(position);</span><br><span class="line">                        <span class="keyword">if</span> (id == params.itemId) &#123;</span><br><span class="line">                            <span class="keyword">return</span> scrapViews.remove(i);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (params.scrappedFromPosition == position) &#123;</span><br><span class="line">                        <span class="keyword">final</span> View scrap = scrapViews.remove(i);</span><br><span class="line">                        clearAccessibilityFromScrap(scrap);</span><br><span class="line">                        <span class="keyword">return</span> scrap;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">final</span> View scrap = scrapViews.remove(size - <span class="number">1</span>);</span><br><span class="line">                clearAccessibilityFromScrap(scrap);</span><br><span class="line">                <span class="keyword">return</span> scrap;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//usage:removeFromActiveViews</span></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Puts a view into the list of scrap views.</span></span><br><span class="line"><span class="comment">         * &lt;p&gt;</span></span><br><span class="line"><span class="comment">         * If the list data hasn't changed or the adapter has stable IDs, views</span></span><br><span class="line"><span class="comment">         * with transient state will be preserved for later retrieval.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> scrap The view to add</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> position The view's position within its parent</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">addScrapView</span><span class="params">(View scrap, <span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> AbsListView.LayoutParams lp = (AbsListView.LayoutParams) scrap.getLayoutParams();</span><br><span class="line">            <span class="keyword">if</span> (lp == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Can't recycle, but we don't know anything about the view.</span></span><br><span class="line">                <span class="comment">// Ignore it completely.</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            lp.scrappedFromPosition = position;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Remove but don't scrap header or footer views, or views that</span></span><br><span class="line">            <span class="comment">// should otherwise not be recycled.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> viewType = lp.viewType;</span><br><span class="line">            <span class="keyword">if</span> (!shouldRecycleViewType(viewType)) &#123;</span><br><span class="line">                <span class="comment">// Can't recycle. If it's not a header or footer, which have</span></span><br><span class="line">                <span class="comment">// special handling and should be ignored, then skip the scrap</span></span><br><span class="line">                <span class="comment">// heap and we'll fully detach the view later.</span></span><br><span class="line">                <span class="keyword">if</span> (viewType != ITEM_VIEW_TYPE_HEADER_OR_FOOTER) &#123;</span><br><span class="line">                    getSkippedScrap().add(scrap);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//................</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Don't scrap views that have transient state.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> scrapHasTransientState = scrap.hasTransientState();</span><br><span class="line">            <span class="keyword">if</span> (scrapHasTransientState) &#123;</span><br><span class="line">            <span class="comment">//...............</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (mViewTypeCount == <span class="number">1</span>) &#123;</span><br><span class="line">                    mCurrentScrap.add(scrap);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mScrapViews[viewType].add(scrap);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (mRecyclerListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mRecyclerListener.onMovedToScrapHeap(scrap);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h5 id="recycle模型"><a href="#recycle模型" class="headerlink" title="recycle模型"></a>recycle模型</h5><p><img src="/images/ListView_RecycleBin.png" alt="ListView_RecycleBin"></p>
<h2 id="onTouchEvent事件的处理"><a href="#onTouchEvent事件的处理" class="headerlink" title="onTouchEvent事件的处理"></a>onTouchEvent事件的处理</h2><h3 id="一般流程-1"><a href="#一般流程-1" class="headerlink" title="一般流程"></a>一般流程</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">AbsListView:</span><br><span class="line">onTouchEvent-&gt;</span><br><span class="line">onTouchMove-&gt;</span><br><span class="line">scrollIfNeeded-&gt;</span><br><span class="line">trackMotionScroll</span><br></pre></td></tr></table></figure>
<h4 id="trackMotionScroll"><a href="#trackMotionScroll" class="headerlink" title="trackMotionScroll"></a>trackMotionScroll</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Track a motion scroll</span></span><br><span class="line"><span class="comment"> * 1.when the motion is moving,you should first addScrapView by inceamentDeltay</span></span><br><span class="line"><span class="comment"> * 2.detachViewsFromParent ,this method to modify the viewTree by motion</span></span><br><span class="line"><span class="comment"> * 3.fillGap</span></span><br><span class="line"><span class="comment"> *   if(incrementalDeltaY &lt; 0)&#123;</span></span><br><span class="line"><span class="comment"> *      //as down</span></span><br><span class="line"><span class="comment"> *      fillDown(int pos, int nextTop)</span></span><br><span class="line"><span class="comment"> *   &#125;else&#123;</span></span><br><span class="line"><span class="comment"> *       //as up</span></span><br><span class="line"><span class="comment"> *      fillUp(int pos, int nextBottom)</span></span><br><span class="line"><span class="comment"> *   &#125;</span></span><br><span class="line"><span class="comment"> * // also here by use the method  makeAndaddView,obtinView,setupView</span></span><br><span class="line"><span class="comment"> *   to reuse the view</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Here is the difference between deltaY and incrementalDeltaY.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> deltaY Amount to offset mMotionView. This is the accumulated delta since the motion</span></span><br><span class="line"><span class="comment"> *        began. Positive numbers mean the user's finger is moving down the screen.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> incrementalDeltaY Change in deltaY from the previous event.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> true if we're already at the beginning/end of the list and have nothing to do.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">trackMotionScroll</span><span class="params">(<span class="keyword">int</span> deltaY, <span class="keyword">int</span> incrementalDeltaY)</span> </span>&#123;</span><br><span class="line">   <span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> height = getHeight() - mPaddingBottom - mPaddingTop;</span><br><span class="line">    <span class="keyword">if</span> (deltaY &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        deltaY = Math.max(-(height - <span class="number">1</span>), deltaY);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        deltaY = Math.min(height - <span class="number">1</span>, deltaY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (incrementalDeltaY &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        incrementalDeltaY = Math.max(-(height - <span class="number">1</span>), incrementalDeltaY);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        incrementalDeltaY = Math.min(height - <span class="number">1</span>, incrementalDeltaY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> down = incrementalDeltaY &lt; <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (down) &#123;</span><br><span class="line">        <span class="comment">//......</span></span><br><span class="line">      <span class="comment">//how to addScrapView by motion down</span></span><br><span class="line">                    mRecycler.addScrapView(child, position);</span><br><span class="line">   </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="comment">//......</span></span><br><span class="line">      <span class="comment">//how to addScrapView by motion up</span></span><br><span class="line">                    mRecycler.addScrapView(child, position);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        detachViewsFromParent(start, count);</span><br><span class="line">        mRecycler.removeSkippedScrap();</span><br><span class="line">   <span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> absIncrementalDeltaY = Math.abs(incrementalDeltaY);</span><br><span class="line">    <span class="keyword">if</span> (spaceAbove &lt; absIncrementalDeltaY || spaceBelow &lt; absIncrementalDeltaY) &#123;</span><br><span class="line">        fillGap(down);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="fillGap"><a href="#fillGap" class="headerlink" title="fillGap"></a>fillGap</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* a interface method for the function with fillDown and fillUp </span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">fillGap</span><span class="params">(<span class="keyword">boolean</span> down)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">int</span> count = getChildCount();</span><br><span class="line">       <span class="keyword">if</span> (down) &#123;</span><br><span class="line">           <span class="keyword">int</span> paddingTop = <span class="number">0</span>;</span><br><span class="line">           <span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</span><br><span class="line">               paddingTop = getListPaddingTop();</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">int</span> startOffset = count &gt; <span class="number">0</span> ? getChildAt(count - <span class="number">1</span>).getBottom() + mDividerHeight :</span><br><span class="line">                   paddingTop;</span><br><span class="line">           fillDown(mFirstPosition + count, startOffset);</span><br><span class="line">           correctTooHigh(getChildCount());</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">int</span> paddingBottom = <span class="number">0</span>;</span><br><span class="line">           <span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</span><br><span class="line">               paddingBottom = getListPaddingBottom();</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">int</span> startOffset = count &gt; <span class="number">0</span> ? getChildAt(<span class="number">0</span>).getTop() - mDividerHeight :</span><br><span class="line">                   getHeight() - paddingBottom;</span><br><span class="line">           fillUp(mFirstPosition - <span class="number">1</span>, startOffset);</span><br><span class="line">           correctTooLow(getChildCount());</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="velocityTracker"><a href="#velocityTracker" class="headerlink" title="velocityTracker"></a>velocityTracker</h3><h4 id="背景-1"><a href="#背景-1" class="headerlink" title="背景"></a>背景</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">手势速度判断的工具类。</span><br><span class="line">用obtain来获取velocityTracker对象；</span><br><span class="line">用addMoveMent来添加需要观察的motionEvent;</span><br><span class="line">用computerCurrentVelocity来计算速度；</span><br><span class="line">用getXVelocity和getYVelocity来做相应的定制化行为处理事件</span><br></pre></td></tr></table></figure>
<h4 id="obtain"><a href="#obtain" class="headerlink" title="obtain"></a>obtain</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> SynchronizedPool&lt;VelocityTracker&gt; sPool =</span><br><span class="line">          <span class="keyword">new</span> SynchronizedPool&lt;VelocityTracker&gt;(<span class="number">2</span>);<span class="comment">//经常使用的耗资源对象 </span></span><br><span class="line"><span class="comment">//......</span></span><br><span class="line">     <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> VelocityTracker <span class="title">obtain</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         VelocityTracker instance = sPool.acquire();</span><br><span class="line">         <span class="keyword">return</span> (instance != <span class="keyword">null</span>) ? instance : <span class="keyword">new</span> VelocityTracker(<span class="keyword">null</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="computerCureentVelocity"><a href="#computerCureentVelocity" class="headerlink" title="computerCureentVelocity"></a>computerCureentVelocity</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">Compute the current velocity based on the points that have been collected. Only call this when you actually want to retrieve velocity information, as it is relatively expensive. You can then retrieve the velocity with getXVelocity() and getYVelocity().</span></span><br><span class="line"><span class="comment">Parameters:</span></span><br><span class="line"><span class="comment">units The units you would like the velocity in. A value of 1 provides pixels per millisecond, 1000 provides pixels per second, etc.</span></span><br><span class="line"><span class="comment">maxVelocity The maximum velocity that can be computed by this method. This value must be declared in the same unit as the units parameter. This value must be positive.</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span>  <span class="title">computeCurrentVelocity</span><span class="params">(<span class="keyword">int</span> units, <span class="keyword">float</span> maxVelocity)</span> </span>&#123;</span><br><span class="line">       nativeComputeCurrentVelocity(mPtr, units, maxVelocity);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="GestureDetector"><a href="#GestureDetector" class="headerlink" title="GestureDetector"></a>GestureDetector</h3><h4 id="背景-2"><a href="#背景-2" class="headerlink" title="背景"></a>背景</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MotionEevent分析工具类</span><br><span class="line">用new GestureDetector(Context context, OnGestureListener listener)的listener传入需要分析的操作类型</span><br><span class="line">用onTouchEvent(MotionEvent event)来分析具体的motion.eg onDoubleTap,onFling etc.</span><br></pre></td></tr></table></figure>
<h3 id="NestedScrolling"><a href="#NestedScrolling" class="headerlink" title="NestedScrolling"></a>NestedScrolling</h3><h4 id="背景-3"><a href="#背景-3" class="headerlink" title="背景"></a>背景</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">痛点:如果子view获得处理touch事件机会的时候，父view就再也没有机会去处理这个touch事件了，直到下一次手指再按下</span><br><span class="line">解决:定义了一套子view的滑动和父view的交互机制</span><br></pre></td></tr></table></figure>
<h4 id="关于ListView的处理"><a href="#关于ListView的处理" class="headerlink" title="关于ListView的处理"></a>关于ListView的处理</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">View (rolePlayer as children)</span><br><span class="line">stopNestedScroll</span><br><span class="line">startNestedScroll</span><br><span class="line">dispatchNestedPreScroll</span><br><span class="line">dispatchNestedScroll</span><br><span class="line"></span><br><span class="line">AbsListView(rolePlayer as parent)</span><br><span class="line">onNestedScroll</span><br><span class="line">onNestedScrollAccepted</span><br><span class="line">onStartNestedScroll</span><br></pre></td></tr></table></figure>
<h4 id="google的再次抽象"><a href="#google的再次抽象" class="headerlink" title="google的再次抽象"></a>google的再次抽象</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">NestedScrollingParent 父容器实现接口</span><br><span class="line">NestedScrollingChild 子容器实现接口</span><br><span class="line">NestedScrollingChildHelper 子容器帮助类,主要作用找到父容器并传递相应参数</span><br><span class="line">NestedScrollingParentHelper 父容器帮助类,主要作用是接受与分发motion事件</span><br><span class="line"></span><br><span class="line">一般流程：</span><br><span class="line">子view的onTouchEvent()</span><br><span class="line"></span><br><span class="line">Motion.Down:</span><br><span class="line">————–Child startNestedScroll—————— </span><br><span class="line">—-Parent   onStartNestedScroll—————- </span><br><span class="line">—-Parent   onNestedScrollAccepted————— </span><br><span class="line"></span><br><span class="line">Motion.Move:</span><br><span class="line">———–Child 把总的滚动距离传给父布局 dispatchNestedPreScroll——– </span><br><span class="line">—-Parent  onNestedPreScroll—————- </span><br><span class="line">———–Child 把剩余的滚动距离传给父布局 dispatchNestedScroll——- </span><br><span class="line">—-Parent  onNestedScroll—————- </span><br><span class="line"></span><br><span class="line">Motion.Up</span><br><span class="line">———–Child 停止滚动 stopNestedScroll————— </span><br><span class="line">—-Parent  onStopNestedScroll—————-</span><br></pre></td></tr></table></figure>
<h3 id="Interpolator"><a href="#Interpolator" class="headerlink" title="Interpolator"></a>Interpolator</h3><h4 id="背景-4"><a href="#背景-4" class="headerlink" title="背景"></a>背景</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">matlab里有一个插值的概念，而在手机app中有很多加速或者减速的运动，需要再相同的时间间隔内获取不同的间距</span><br></pre></td></tr></table></figure>
<h4 id="getInterpolation"><a href="#getInterpolation" class="headerlink" title="getInterpolation"></a>getInterpolation</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//eg:DecelerateInterpolator</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * An interpolator where the rate of change starts out quickly and</span></span><br><span class="line"><span class="comment"> * and then decelerates.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructor</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> factor Degree to which the animation should be eased. Setting factor to 1.0f produces</span></span><br><span class="line"><span class="comment">     *        an upside-down y=x^2 parabola. Increasing factor above 1.0f makes exaggerates the</span></span><br><span class="line"><span class="comment">     *        ease-out effect (i.e., it starts even faster and ends evens slower)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DecelerateInterpolator</span><span class="params">(<span class="keyword">float</span> factor)</span> </span>&#123;</span><br><span class="line">        mFactor = factor;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//input 从0到1的匀速时间的百分比</span></span><br><span class="line"><span class="comment">//output 对应时间百分比下的value的百分比,有可能大于1或者小于0的情况.</span></span><br><span class="line"><span class="comment">//获得output值后根据自身的实际情况来更新视图</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getInterpolation</span><span class="params">(<span class="keyword">float</span> input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">float</span> result;</span><br><span class="line">        <span class="keyword">if</span> (mFactor == <span class="number">1.0f</span>) &#123;</span><br><span class="line">            result = (<span class="keyword">float</span>)(<span class="number">1.0f</span> - (<span class="number">1.0f</span> - input) * (<span class="number">1.0f</span> - input));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result = (<span class="keyword">float</span>)(<span class="number">1.0f</span> - Math.pow((<span class="number">1.0f</span> - input), <span class="number">2</span> * mFactor));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//......</span></span><br></pre></td></tr></table></figure>
<h2 id="ListView点击事件"><a href="#ListView点击事件" class="headerlink" title="ListView点击事件"></a>ListView点击事件</h2><h3 id="为什么点击失效了"><a href="#为什么点击失效了" class="headerlink" title="为什么点击失效了"></a>为什么点击失效了</h3><ul>
<li><p>WHAT</p>
<p>在Listview的Item里面有一个Button,那么这个item的点击事件往往不会被触发到</p>
</li>
<li><p>HOW</p>
<p>在Item的根布局上增加,android:descendantFocusability=”blocksDescendants”</p>
</li>
<li><p>WHY</p>
<ol>
<li><p>Descendant</p>
<h5 id="焦点管理"><a href="#焦点管理" class="headerlink" title="焦点管理"></a>焦点管理</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">requestFocus -&gt; </span><br><span class="line">requestFocusNoSearch -&gt; </span><br><span class="line">handleFocusGainInternal -&gt; (dispatchOnGlobalFocusChange,onFocusChanged,refreshDrawableState)</span><br></pre></td></tr></table></figure>
<h5 id="requestFocusNoSearch"><a href="#requestFocusNoSearch" class="headerlink" title="requestFocusNoSearch"></a>requestFocusNoSearch</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">requestFocusNoSearch</span><span class="params">(<span class="keyword">int</span> direction, Rect previouslyFocusedRect)</span> </span>&#123;</span><br><span class="line">     <span class="comment">// need to be focusable</span></span><br><span class="line">     <span class="keyword">if</span> ((mViewFlags &amp; FOCUSABLE_MASK) != FOCUSABLE ||</span><br><span class="line">             (mViewFlags &amp; VISIBILITY_MASK) != VISIBLE) &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// need to be focusable in touch mode if in touch mode</span></span><br><span class="line">     <span class="keyword">if</span> (isInTouchMode() &amp;&amp;</span><br><span class="line">         (FOCUSABLE_IN_TOUCH_MODE != (mViewFlags &amp; FOCUSABLE_IN_TOUCH_MODE))) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//the xml tag works here</span></span><br><span class="line">     <span class="comment">// need to not have any parents blocking us</span></span><br><span class="line">     <span class="keyword">if</span> (hasAncestorThatBlocksDescendantFocus()) &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     handleFocusGainInternal(direction, previouslyFocusedRect);</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h5 id="handleFocusGainInternal"><a href="#handleFocusGainInternal" class="headerlink" title="handleFocusGainInternal"></a>handleFocusGainInternal</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*Three things to do</span></span><br><span class="line"><span class="comment">* 1.onFocusChange</span></span><br><span class="line"><span class="comment">* 2.dispatchFocusChange</span></span><br><span class="line"><span class="comment">* 3.refreshDrawableState</span></span><br><span class="line"><span class="comment"> * Give this view focus. This will cause</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #onFocusChanged(boolean, int, android.graphics.Rect)&#125; to be called.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Note: this does not check whether this &#123;<span class="doctag">@link</span> View&#125; should get focus, it just</span></span><br><span class="line"><span class="comment"> * gives it focus no matter what.  It should only be called internally by framework</span></span><br><span class="line"><span class="comment"> * code that knows what it is doing, namely &#123;<span class="doctag">@link</span> #requestFocus(int, Rect)&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> direction values are &#123;<span class="doctag">@link</span> View#FOCUS_UP&#125;, &#123;<span class="doctag">@link</span> View#FOCUS_DOWN&#125;,</span></span><br><span class="line"><span class="comment"> *        &#123;<span class="doctag">@link</span> View#FOCUS_LEFT&#125; or &#123;<span class="doctag">@link</span> View#FOCUS_RIGHT&#125;. This is the direction which</span></span><br><span class="line"><span class="comment"> *        focus moved when requestFocus() is called. It may not always</span></span><br><span class="line"><span class="comment"> *        apply, in which case use the default View.FOCUS_DOWN.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> previouslyFocusedRect The rectangle of the view that had focus</span></span><br><span class="line"><span class="comment"> *        prior in this View's coordinate system.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handleFocusGainInternal</span><span class="params">(@FocusRealDirection <span class="keyword">int</span> direction, Rect previouslyFocusedRect)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DBG) &#123;</span><br><span class="line">        System.out.println(<span class="keyword">this</span> + <span class="string">" requestFocus()"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_FOCUSED) == <span class="number">0</span>) &#123;</span><br><span class="line">        mPrivateFlags |= PFLAG_FOCUSED;</span><br><span class="line"></span><br><span class="line">        View oldFocus = (mAttachInfo != <span class="keyword">null</span>) ? getRootView().findFocus() : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mParent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mParent.requestChildFocus(<span class="keyword">this</span>, <span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mAttachInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mAttachInfo.mTreeObserver.dispatchOnGlobalFocusChange(oldFocus, <span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        onFocusChanged(<span class="keyword">true</span>, direction, previouslyFocusedRect);</span><br><span class="line">        refreshDrawableState();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​</p>
</li>
<li><p>ItemOnClick事件</p>
<h5 id="处理流程"><a href="#处理流程" class="headerlink" title="处理流程"></a>处理流程</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">abslistView:onTouchEvent()</span><br><span class="line">-&gt;onTouchUp()</span><br><span class="line">-&gt;PerformClick.run()</span><br></pre></td></tr></table></figure>
<h5 id="onTouchUp"><a href="#onTouchUp" class="headerlink" title="onTouchUp"></a>onTouchUp</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onTouchUp</span><span class="params">(MotionEvent ev)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">switch</span> (mTouchMode) &#123;</span><br><span class="line">      <span class="keyword">case</span> TOUCH_MODE_DOWN:</span><br><span class="line">      <span class="keyword">case</span> TOUCH_MODE_TAP:</span><br><span class="line">      <span class="keyword">case</span> TOUCH_MODE_DONE_WAITING:</span><br><span class="line">          <span class="keyword">final</span> <span class="keyword">int</span> motionPosition = mMotionPosition;</span><br><span class="line">          <span class="keyword">final</span> View child = getChildAt(motionPosition - mFirstPosition);</span><br><span class="line">          <span class="keyword">if</span> (child != <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="keyword">if</span> (mTouchMode != TOUCH_MODE_DOWN) &#123;</span><br><span class="line">                  child.setPressed(<span class="keyword">false</span>);</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              <span class="keyword">final</span> <span class="keyword">float</span> x = ev.getX();</span><br><span class="line">              <span class="keyword">final</span> <span class="keyword">boolean</span> inList = x &gt; mListPadding.left &amp;&amp; x &lt; getWidth() - mListPadding.right;</span><br><span class="line">              <span class="comment">// here to decide to invoke which child</span></span><br><span class="line">              <span class="keyword">if</span> (inList &amp;&amp; !child.hasFocusable()) &#123;</span><br><span class="line">              <span class="comment">//.......</span></span><br><span class="line">                 ｝</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> TOUCH_MODE_SCROLL:</span><br><span class="line">         <span class="comment">//......</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>​</p>
</li>
</ol>
</li>
</ul>
<h2 id="扩展功能"><a href="#扩展功能" class="headerlink" title="扩展功能"></a>扩展功能</h2><h3 id="阻尼效果"><a href="#阻尼效果" class="headerlink" title="阻尼效果"></a>阻尼效果</h3><h4 id="背景-5"><a href="#背景-5" class="headerlink" title="背景"></a>背景</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ios 在系统层面上实现了触碰边缘的阻尼回弹效果,通知用户已经到达了边界。但是由于专利的问题，android在无法在系统层面上使用统一的效果，但是通过了一个渐变的颜色来告知用户已经到达了边界状态</span><br></pre></td></tr></table></figure>
<h4 id="How-to-Invoke"><a href="#How-to-Invoke" class="headerlink" title="How to Invoke"></a>How to Invoke</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">AbsListView:onTouchEvent-&gt;</span><br><span class="line">AbsListView:onTouchMove-&gt;</span><br><span class="line">AbsListView:startScrollIfNeeded-&gt;</span><br><span class="line">AbsListView:scrollIfNeeded-&gt;//effect</span><br><span class="line">View:overScrollBy-&gt;//action</span><br><span class="line">View:onOverScrolled</span><br></pre></td></tr></table></figure>
<h4 id="overScrollBy"><a href="#overScrollBy" class="headerlink" title="overScrollBy"></a>overScrollBy</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1.this is a method help for caculate the distance when overScroll has happened</span></span><br><span class="line"><span class="comment"> * 2.ListView,Webview,ScrollView,HorizontalScrollView has then same scource code</span></span><br><span class="line"><span class="comment"> * 3.when to peresent when overScroll,this is decided by the overridde method onOverScrolled</span></span><br><span class="line"><span class="comment"> * 4.ablistview input the valus maxOverScrollY = ViewConfiguration.mOverscrollDistance = 0;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Scroll the view with standard behavior for scrolling beyond the normal</span></span><br><span class="line"><span class="comment"> * content boundaries. Views that call this method should override</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #onOverScrolled(int, int, boolean, boolean)&#125; to respond to the</span></span><br><span class="line"><span class="comment"> * results of an over-scroll operation.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Views can use this method to handle any touch or fling-based scrolling.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> deltaX Change in X in pixels</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> deltaY Change in Y in pixels</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> scrollX Current X scroll value in pixels before applying deltaX</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> scrollY Current Y scroll value in pixels before applying deltaY</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> scrollRangeX Maximum content scroll range along the X axis</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> scrollRangeY Maximum content scroll range along the Y axis</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> maxOverScrollX Number of pixels to overscroll by in either direction</span></span><br><span class="line"><span class="comment"> *          along the X axis.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> maxOverScrollY Number of pixels to overscroll by in either direction</span></span><br><span class="line"><span class="comment"> *          along the Y axis.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> isTouchEvent true if this scroll operation is the result of a touch event.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> true if scrolling was clamped to an over-scroll boundary along either</span></span><br><span class="line"><span class="comment"> *          axis, false otherwise.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"UnusedParameters"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">overScrollBy</span><span class="params">(<span class="keyword">int</span> deltaX, <span class="keyword">int</span> deltaY,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> scrollX, <span class="keyword">int</span> scrollY,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> scrollRangeX, <span class="keyword">int</span> scrollRangeY,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> maxOverScrollX, <span class="keyword">int</span> maxOverScrollY,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> isTouchEvent)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> overScrollMode = mOverScrollMode;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> canScrollHorizontal =</span><br><span class="line">            computeHorizontalScrollRange() &gt; computeHorizontalScrollExtent();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> canScrollVertical =</span><br><span class="line">            computeVerticalScrollRange() &gt; computeVerticalScrollExtent();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> overScrollHorizontal = overScrollMode == OVER_SCROLL_ALWAYS ||</span><br><span class="line">            (overScrollMode == OVER_SCROLL_IF_CONTENT_SCROLLS &amp;&amp; canScrollHorizontal);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> overScrollVertical = overScrollMode == OVER_SCROLL_ALWAYS ||</span><br><span class="line">            (overScrollMode == OVER_SCROLL_IF_CONTENT_SCROLLS &amp;&amp; canScrollVertical);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> newScrollX = scrollX + deltaX;</span><br><span class="line">    <span class="keyword">if</span> (!overScrollHorizontal) &#123;</span><br><span class="line">        maxOverScrollX = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> newScrollY = scrollY + deltaY;</span><br><span class="line">    <span class="keyword">if</span> (!overScrollVertical) &#123;</span><br><span class="line">        maxOverScrollY = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Clamp values if at the limits and record</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> left = -maxOverScrollX;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> right = maxOverScrollX + scrollRangeX;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> top = -maxOverScrollY;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> bottom = maxOverScrollY + scrollRangeY;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> clampedX = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (newScrollX &gt; right) &#123;</span><br><span class="line">        newScrollX = right;</span><br><span class="line">        clampedX = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newScrollX &lt; left) &#123;</span><br><span class="line">        newScrollX = left;</span><br><span class="line">        clampedX = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> clampedY = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (newScrollY &gt; bottom) &#123;</span><br><span class="line">        newScrollY = bottom;</span><br><span class="line">        clampedY = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newScrollY &lt; top) &#123;</span><br><span class="line">        newScrollY = top;</span><br><span class="line">        clampedY = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    onOverScrolled(newScrollX, newScrollY, clampedX, clampedY);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> clampedX || clampedY;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Android的原生阻尼"><a href="#Android的原生阻尼" class="headerlink" title="Android的原生阻尼"></a>Android的原生阻尼</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * use </span></span><br><span class="line"><span class="comment">     * EdgeEffect mEdgeGlowTop;Tracks the state of the top edge glow.</span></span><br><span class="line"><span class="comment">     * EdgeEffect mEdgeGlowBottom;Tracks the state of the bottom edge glow.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> x</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> y</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> vtev </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scrollIfNeeded</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, MotionEvent vtev)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">                            <span class="keyword">final</span> <span class="keyword">int</span> overscrollMode = getOverScrollMode();</span><br><span class="line">                            <span class="keyword">if</span> (overscrollMode == OVER_SCROLL_ALWAYS ||</span><br><span class="line">                                    (overscrollMode == OVER_SCROLL_IF_CONTENT_SCROLLS &amp;&amp;</span><br><span class="line">                                            !contentFits())) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (!atOverscrollEdge) &#123;</span><br><span class="line">                                    mDirection = <span class="number">0</span>; <span class="comment">// Reset when entering overscroll.</span></span><br><span class="line">                                    mTouchMode = TOUCH_MODE_OVERSCROLL;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">if</span> (incrementalDeltaY &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                    mEdgeGlowTop.onPull((<span class="keyword">float</span>) -overscroll / getHeight(),</span><br><span class="line">                                            (<span class="keyword">float</span>) x / getWidth());</span><br><span class="line">                                    <span class="keyword">if</span> (!mEdgeGlowBottom.isFinished()) &#123;</span><br><span class="line">                                        mEdgeGlowBottom.onRelease();</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    invalidateTopGlow();</span><br><span class="line">                                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (incrementalDeltaY &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                                    mEdgeGlowBottom.onPull((<span class="keyword">float</span>) overscroll / getHeight(),</span><br><span class="line">                                            <span class="number">1</span>.f - (<span class="keyword">float</span>) x / getWidth());</span><br><span class="line">                                    <span class="keyword">if</span> (!mEdgeGlowTop.isFinished()) &#123;</span><br><span class="line">                                        mEdgeGlowTop.onRelease();</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    invalidateBottomGlow();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    mMotionY = y + lastYCorrection + scrollOffsetCorrection;</span><br><span class="line">                &#125;</span><br><span class="line">                mLastY = y + lastYCorrection + scrollOffsetCorrection;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mTouchMode == TOUCH_MODE_OVERSCROLL) &#123;</span><br><span class="line">            <span class="keyword">if</span> (y != mLastY) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> oldScroll = mScrollY;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> newScroll = oldScroll - incrementalDeltaY;</span><br><span class="line">                <span class="keyword">int</span> newDirection = y &gt; mLastY ? <span class="number">1</span> : -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (mDirection == <span class="number">0</span>) &#123;</span><br><span class="line">                    mDirection = newDirection;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">int</span> overScrollDistance = -incrementalDeltaY;</span><br><span class="line">                <span class="keyword">if</span> ((newScroll &lt; <span class="number">0</span> &amp;&amp; oldScroll &gt;= <span class="number">0</span>) || (newScroll &gt; <span class="number">0</span> &amp;&amp; oldScroll &lt;= <span class="number">0</span>)) &#123;</span><br><span class="line">                    overScrollDistance = -oldScroll;</span><br><span class="line">                    incrementalDeltaY += overScrollDistance;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    incrementalDeltaY = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (overScrollDistance != <span class="number">0</span>) &#123;</span><br><span class="line">                    overScrollBy(<span class="number">0</span>, overScrollDistance, <span class="number">0</span>, mScrollY, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">                            <span class="number">0</span>, mOverscrollDistance, <span class="keyword">true</span>);</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> overscrollMode = getOverScrollMode();</span><br><span class="line">                    <span class="keyword">if</span> (overscrollMode == OVER_SCROLL_ALWAYS ||</span><br><span class="line">                            (overscrollMode == OVER_SCROLL_IF_CONTENT_SCROLLS &amp;&amp;</span><br><span class="line">                                    !contentFits())) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (rawDeltaY &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            mEdgeGlowTop.onPull((<span class="keyword">float</span>) overScrollDistance / getHeight(),</span><br><span class="line">                                    (<span class="keyword">float</span>) x / getWidth());</span><br><span class="line">                            <span class="keyword">if</span> (!mEdgeGlowBottom.isFinished()) &#123;</span><br><span class="line">                                mEdgeGlowBottom.onRelease();</span><br><span class="line">                            &#125;</span><br><span class="line">                            invalidateTopGlow();</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rawDeltaY &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                            mEdgeGlowBottom.onPull((<span class="keyword">float</span>) overScrollDistance / getHeight(),</span><br><span class="line">                                    <span class="number">1</span>.f - (<span class="keyword">float</span>) x / getWidth());</span><br><span class="line">                            <span class="keyword">if</span> (!mEdgeGlowTop.isFinished()) &#123;</span><br><span class="line">                                mEdgeGlowTop.onRelease();</span><br><span class="line">                            &#125;</span><br><span class="line">                            invalidateBottomGlow();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"><span class="comment">//.......</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="EdgeEeffect"><a href="#EdgeEeffect" class="headerlink" title="EdgeEeffect"></a>EdgeEeffect</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * update state</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> time = AnimationUtils.currentAnimationTimeMillis();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">float</span> t = Math.min((time - mStartTime) / mDuration, <span class="number">1</span>.f);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">float</span> interp = mInterpolator.getInterpolation(t);</span><br><span class="line"></span><br><span class="line">    mGlowAlpha = mGlowAlphaStart + (mGlowAlphaFinish - mGlowAlphaStart) * interp;</span><br><span class="line">    mGlowScaleY = mGlowScaleYStart + (mGlowScaleYFinish - mGlowScaleYStart) * interp;</span><br><span class="line">    mDisplacement = (mDisplacement + mTargetDisplacement) / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (t &gt;= <span class="number">1</span>.f - EPSILON) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (mState) &#123;</span><br><span class="line">            <span class="comment">//start to init parameter</span></span><br><span class="line">            <span class="keyword">case</span> STATE_ABSORB:</span><br><span class="line"></span><br><span class="line">                mState = STATE_RECEDE;</span><br><span class="line">                mStartTime = AnimationUtils.currentAnimationTimeMillis();</span><br><span class="line">                mDuration = RECEDE_TIME;</span><br><span class="line"></span><br><span class="line">                mGlowAlphaStart = mGlowAlpha;</span><br><span class="line">                mGlowScaleYStart = mGlowScaleY;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// After absorb, the glow should fade to nothing.</span></span><br><span class="line">                mGlowAlphaFinish = <span class="number">0</span>.f;</span><br><span class="line">                mGlowScaleYFinish = <span class="number">0</span>.f;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">//the pull motivation</span></span><br><span class="line">            <span class="keyword">case</span> STATE_PULL:</span><br><span class="line">                mState = STATE_PULL_DECAY;</span><br><span class="line">                mStartTime = AnimationUtils.currentAnimationTimeMillis();</span><br><span class="line">                mDuration = PULL_DECAY_TIME;</span><br><span class="line"></span><br><span class="line">                mGlowAlphaStart = mGlowAlpha;</span><br><span class="line">                mGlowScaleYStart = mGlowScaleY;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// After pull, the glow should fade to nothing.</span></span><br><span class="line">                mGlowAlphaFinish = <span class="number">0</span>.f;</span><br><span class="line">                mGlowScaleYFinish = <span class="number">0</span>.f;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">             <span class="comment">// decay</span></span><br><span class="line">            <span class="keyword">case</span> STATE_PULL_DECAY:</span><br><span class="line">                mState = STATE_RECEDE;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">//finished</span></span><br><span class="line">            <span class="keyword">case</span> STATE_RECEDE:</span><br><span class="line">                mState = STATE_IDLE;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="SwipeRefreshLayout下拉刷新-上拉加载更多"><a href="#SwipeRefreshLayout下拉刷新-上拉加载更多" class="headerlink" title="SwipeRefreshLayout下拉刷新/上拉加载更多"></a>SwipeRefreshLayout下拉刷新/上拉加载更多</h3><h4 id="how-to-create"><a href="#how-to-create" class="headerlink" title="how to create"></a>how to create</h4><h5 id="contruction"><a href="#contruction" class="headerlink" title="contruction"></a>contruction</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SwipeRefreshLayout extends ViewGroup </span></span><br><span class="line"><span class="comment"> * Constructor that is called when inflating SwipeRefreshLayout from XML.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> attrs</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SwipeRefreshLayout</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(context, attrs);</span><br><span class="line"></span><br><span class="line">    mTouchSlop = ViewConfiguration.get(context).getScaledTouchSlop();</span><br><span class="line"></span><br><span class="line">    mMediumAnimationDuration = getResources().getInteger(</span><br><span class="line">            android.R.integer.config_mediumAnimTime);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ViewGroup subClass call this,setWillNotDraw to forbidden the callback method onDraw()</span></span><br><span class="line">    setWillNotDraw(<span class="keyword">false</span>);</span><br><span class="line">    mDecelerateInterpolator = <span class="keyword">new</span> DecelerateInterpolator(DECELERATE_INTERPOLATION_FACTOR);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> TypedArray a = context.obtainStyledAttributes(attrs, LAYOUT_ATTRS);</span><br><span class="line">    setEnabled(a.getBoolean(<span class="number">0</span>, <span class="keyword">true</span>));</span><br><span class="line">    a.recycle();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> DisplayMetrics metrics = getResources().getDisplayMetrics();</span><br><span class="line">    mCircleWidth = (<span class="keyword">int</span>) (CIRCLE_DIAMETER * metrics.density);</span><br><span class="line">    mCircleHeight = (<span class="keyword">int</span>) (CIRCLE_DIAMETER * metrics.density);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//create the pull View,here use the progressView </span></span><br><span class="line">    createProgressView();</span><br><span class="line">    ViewCompat.setChildrenDrawingOrderEnabled(<span class="keyword">this</span>, <span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">// the absolute offset has to take into account that the circle starts at an offset</span></span><br><span class="line">    <span class="comment">//max pull distance</span></span><br><span class="line">    mSpinnerFinalOffset = DEFAULT_CIRCLE_TARGET * metrics.density;</span><br><span class="line">    mTotalDragDistance = mSpinnerFinalOffset;</span><br><span class="line">    mNestedScrollingParentHelper = <span class="keyword">new</span> NestedScrollingParentHelper(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    mNestedScrollingChildHelper = <span class="keyword">new</span> NestedScrollingChildHelper(<span class="keyword">this</span>);</span><br><span class="line">    setNestedScrollingEnabled(<span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="onMeasure-1"><a href="#onMeasure-1" class="headerlink" title="onMeasure"></a>onMeasure</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1.find the right target ,this is inside the swipeLayout by static xml;</span></span><br><span class="line"><span class="comment"> * 2.measure the target manually</span></span><br><span class="line"><span class="comment"> * 3.measure the added view which is inserted by the constructon method.here is the mCircleView</span></span><br><span class="line"><span class="comment"> * 4.initial the value mOriginalOffsetTop. stand on the mTargetView//negative value</span></span><br><span class="line"><span class="comment"> * 5.get the CircleIndex in parentView and store it in mCircleViewIndex</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> widthMeasureSpec</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> heightMeasureSpec</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">    <span class="keyword">if</span> (mTarget == <span class="keyword">null</span>) &#123;</span><br><span class="line">        ensureTarget();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mTarget == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mTarget.measure(MeasureSpec.makeMeasureSpec(</span><br><span class="line">            getMeasuredWidth() - getPaddingLeft() - getPaddingRight(),</span><br><span class="line">            MeasureSpec.EXACTLY), MeasureSpec.makeMeasureSpec(</span><br><span class="line">            getMeasuredHeight() - getPaddingTop() - getPaddingBottom(), MeasureSpec.EXACTLY));</span><br><span class="line">    mCircleView.measure(MeasureSpec.makeMeasureSpec(mCircleWidth, MeasureSpec.EXACTLY),</span><br><span class="line">            MeasureSpec.makeMeasureSpec(mCircleHeight, MeasureSpec.EXACTLY));</span><br><span class="line">    <span class="keyword">if</span> (!mUsingCustomStart &amp;&amp; !mOriginalOffsetCalculated) &#123;</span><br><span class="line">        mOriginalOffsetCalculated = <span class="keyword">true</span>;</span><br><span class="line">        mCurrentTargetOffsetTop = mOriginalOffsetTop = -mCircleView.getMeasuredHeight();<span class="comment">//stand on the mTargetView</span></span><br><span class="line">    &#125;</span><br><span class="line">    mCircleViewIndex = -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// Get the index of the circleview.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; getChildCount(); index++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (getChildAt(index) == mCircleView) &#123;</span><br><span class="line">            mCircleViewIndex = index;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="onLayout-1"><a href="#onLayout-1" class="headerlink" title="onLayout"></a>onLayout</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1. layout the target view</span></span><br><span class="line"><span class="comment"> * left = getPaddingLeft()</span></span><br><span class="line"><span class="comment"> * right = getPaddingLeft()+ [width - getPaddingLeft() - getPaddingRight()]</span></span><br><span class="line"><span class="comment"> * top = getPaddingTop()</span></span><br><span class="line"><span class="comment"> * bottom = getPaddingTop()+[height - getPaddingTop() - getPaddingBottom()]</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 2.layout the mCircleView</span></span><br><span class="line"><span class="comment"> * left = make the circleView centerX</span></span><br><span class="line"><span class="comment"> * right = make the circleView centerX</span></span><br><span class="line"><span class="comment"> * top = above targetView mCurrentTargetOffsetTop</span></span><br><span class="line"><span class="comment"> * bottom = alginTop of targetView</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> changed</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> left</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> top</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> right</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bottom</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> width = getMeasuredWidth();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> height = getMeasuredHeight();</span><br><span class="line">    <span class="keyword">if</span> (getChildCount() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mTarget == <span class="keyword">null</span>) &#123;</span><br><span class="line">        ensureTarget();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mTarget == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> View child = mTarget;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childLeft = getPaddingLeft();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childTop = getPaddingTop();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childWidth = width - getPaddingLeft() - getPaddingRight();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childHeight = height - getPaddingTop() - getPaddingBottom();</span><br><span class="line">    child.layout(childLeft, childTop, childLeft + childWidth, childTop + childHeight);</span><br><span class="line">    <span class="keyword">int</span> circleWidth = mCircleView.getMeasuredWidth();</span><br><span class="line">    <span class="keyword">int</span> circleHeight = mCircleView.getMeasuredHeight();</span><br><span class="line">    mCircleView.layout((width / <span class="number">2</span> - circleWidth / <span class="number">2</span>), mCurrentTargetOffsetTop,</span><br><span class="line">            (width / <span class="number">2</span> + circleWidth / <span class="number">2</span>), mCurrentTargetOffsetTop + circleHeight);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="touchEvent-amp-amp-stateChange"><a href="#touchEvent-amp-amp-stateChange" class="headerlink" title="touchEvent&amp;&amp;stateChange"></a>touchEvent&amp;&amp;stateChange</h4><h5 id="onInterceptTouchEvent"><a href="#onInterceptTouchEvent" class="headerlink" title="onInterceptTouchEvent"></a>onInterceptTouchEvent</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * consider when to intercept</span></span><br><span class="line"><span class="comment"> * 1.reverse condition:canScrollUp,inRefreshState// not block</span></span><br><span class="line"><span class="comment"> * 2.and then sequence condition:moveDistance larger than touchSlop// block</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ev</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onInterceptTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</span><br><span class="line">    ensureTarget();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> action = MotionEventCompat.getActionMasked(ev);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mReturningToStart &amp;&amp; action == MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">        mReturningToStart = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isEnabled() || mReturningToStart || canChildScrollUp() || mRefreshing) &#123;</span><br><span class="line">        <span class="comment">// Fail fast if we're not in a state where a swipe is possible</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (action) &#123;</span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">            setTargetOffsetTopAndBottom(mOriginalOffsetTop - mCircleView.getTop(), <span class="keyword">true</span>);</span><br><span class="line">            mActivePointerId = MotionEventCompat.getPointerId(ev, <span class="number">0</span>);</span><br><span class="line">            mIsBeingDragged = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">float</span> initialDownY = getMotionEventY(ev, mActivePointerId);</span><br><span class="line">            <span class="keyword">if</span> (initialDownY == -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            mInitialDownY = initialDownY;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">            <span class="keyword">if</span> (mActivePointerId == INVALID_POINTER) &#123;</span><br><span class="line">                Log.e(LOG_TAG, <span class="string">"Got ACTION_MOVE event but don't have an active pointer id."</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">float</span> y = getMotionEventY(ev, mActivePointerId);</span><br><span class="line">            <span class="keyword">if</span> (y == -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">float</span> yDiff = y - mInitialDownY;</span><br><span class="line">            <span class="keyword">if</span> (yDiff &gt; mTouchSlop &amp;&amp; !mIsBeingDragged) &#123;</span><br><span class="line">                mInitialMotionY = mInitialDownY + mTouchSlop;<span class="comment">// record startY</span></span><br><span class="line">                mIsBeingDragged = <span class="keyword">true</span>;</span><br><span class="line">                mProgress.setAlpha(STARTING_PROGRESS_ALPHA);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> MotionEventCompat.ACTION_POINTER_UP:</span><br><span class="line">            onSecondaryPointerUp(ev);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_CANCEL:</span><br><span class="line">            mIsBeingDragged = <span class="keyword">false</span>;</span><br><span class="line">            mActivePointerId = INVALID_POINTER;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mIsBeingDragged;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="onTouchEvent"><a href="#onTouchEvent" class="headerlink" title="onTouchEvent"></a>onTouchEvent</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> action = MotionEventCompat.getActionMasked(ev);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mReturningToStart &amp;&amp; action == MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">        mReturningToStart = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isEnabled() || mReturningToStart || canChildScrollUp()) &#123;</span><br><span class="line">        <span class="comment">// Fail fast if we're not in a state where a swipe is possible</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (action) &#123;</span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">            mActivePointerId = MotionEventCompat.getPointerId(ev, <span class="number">0</span>);</span><br><span class="line">            mIsBeingDragged = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_MOVE: &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> pointerIndex = MotionEventCompat.findPointerIndex(ev, mActivePointerId);</span><br><span class="line">            <span class="keyword">if</span> (pointerIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                Log.e(LOG_TAG, <span class="string">"Got ACTION_MOVE event but have an invalid active pointer id."</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">float</span> y = MotionEventCompat.getY(ev, pointerIndex);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">float</span> overscrollTop = (y - mInitialMotionY) * DRAG_RATE;</span><br><span class="line">            <span class="comment">//开始pull 并且超过了一半</span></span><br><span class="line">            <span class="keyword">if</span> (mIsBeingDragged) &#123;</span><br><span class="line">                <span class="keyword">if</span> (overscrollTop &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//do animation</span></span><br><span class="line">                    moveSpinner(overscrollTop);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> MotionEventCompat.ACTION_POINTER_DOWN: &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> index = MotionEventCompat.getActionIndex(ev);</span><br><span class="line">            mActivePointerId = MotionEventCompat.getPointerId(ev, index);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> MotionEventCompat.ACTION_POINTER_UP:</span><br><span class="line">            onSecondaryPointerUp(ev);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_CANCEL: &#123;</span><br><span class="line">            <span class="keyword">if</span> (mActivePointerId == INVALID_POINTER) &#123;</span><br><span class="line">                <span class="keyword">if</span> (action == MotionEvent.ACTION_UP) &#123;</span><br><span class="line">                    Log.e(LOG_TAG, <span class="string">"Got ACTION_UP event but don't have an active pointer id."</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> pointerIndex = MotionEventCompat.findPointerIndex(ev, mActivePointerId);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">float</span> y = MotionEventCompat.getY(ev, pointerIndex);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">float</span> overscrollTop = (y - mInitialMotionY) * DRAG_RATE;</span><br><span class="line">            mIsBeingDragged = <span class="keyword">false</span>;</span><br><span class="line">            finishSpinner(overscrollTop);<span class="comment">//cancel animation</span></span><br><span class="line">            mActivePointerId = INVALID_POINTER;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="add-header-and-footer-yourself"><a href="#add-header-and-footer-yourself" class="headerlink" title="add header and footer yourself"></a>add header and footer yourself</h4><p>用progressView一样的方式去添加</p>
<h5 id="construction"><a href="#construction" class="headerlink" title="construction"></a>construction</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SwipeRefreshLayout</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">super</span>(context, attrs);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    addView(mHeadViewContainer);</span><br><span class="line">    ......</span><br><span class="line">    addView(mFooterViewContainer);</span><br><span class="line">    ......</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h5 id="onMeasure-2"><a href="#onMeasure-2" class="headerlink" title="onMeasure"></a>onMeasure</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">        .......</span><br><span class="line">          <span class="comment">// measure Header</span></span><br><span class="line">        mHeadViewContainer.measure(MeasureSpec.makeMeasureSpec(</span><br><span class="line">                mHeaderViewWidth, MeasureSpec.EXACTLY), MeasureSpec</span><br><span class="line">                .makeMeasureSpec(mHeaderViewHeight, MeasureSpec.EXACTLY));</span><br><span class="line">         <span class="comment">// measure Footer</span></span><br><span class="line">        mFooterViewContainer.measure(MeasureSpec.makeMeasureSpec(</span><br><span class="line">                mFooterViewWidth, MeasureSpec.EXACTLY), MeasureSpec</span><br><span class="line">                .makeMeasureSpec(mFooterViewHeight, MeasureSpec.EXACTLY));</span><br><span class="line">        ......</span><br><span class="line">          <span class="comment">//record header index</span></span><br><span class="line">        mHeaderViewIndex = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; getChildCount(); index++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (getChildAt(index) == mHeadViewContainer) &#123;</span><br><span class="line">                mHeaderViewIndex = index;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">//record footer index</span></span><br><span class="line">        mFooterViewIndex = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; getChildCount(); index++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (getChildAt(index) == mFooterViewContainer) &#123;</span><br><span class="line">                mFooterViewIndex = index;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="onLayout-2"><a href="#onLayout-2" class="headerlink" title="onLayout"></a>onLayout</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right,</span></span></span><br><span class="line"><span class="function"><span class="params">           <span class="keyword">int</span> bottom)</span> </span>&#123;</span><br><span class="line">       ......</span><br><span class="line">       <span class="keyword">int</span> headViewWidth = mHeadViewContainer.getMeasuredWidth();</span><br><span class="line">       <span class="keyword">int</span> headViewHeight = mHeadViewContainer.getMeasuredHeight();</span><br><span class="line">       mHeadViewContainer.layout((width / <span class="number">2</span> - headViewWidth / <span class="number">2</span>),</span><br><span class="line">               mCurrentTargetOffsetTop, (width / <span class="number">2</span> + headViewWidth / <span class="number">2</span>),</span><br><span class="line">               mCurrentTargetOffsetTop + headViewHeight);</span><br><span class="line">       <span class="keyword">int</span> footViewWidth = mFooterViewContainer.getMeasuredWidth();</span><br><span class="line">       <span class="keyword">int</span> footViewHeight = mFooterViewContainer.getMeasuredHeight();</span><br><span class="line">       mFooterViewContainer.layout((width / <span class="number">2</span> - footViewWidth / <span class="number">2</span>), height</span><br><span class="line">               - pushDistance, (width / <span class="number">2</span> + footViewWidth / <span class="number">2</span>), height</span><br><span class="line">               + footViewHeight - pushDistance);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h5 id="notify-pull-and-push-Action"><a href="#notify-pull-and-push-Action" class="headerlink" title="notify pull and push Action"></a>notify pull and push Action</h5><p>如何判断到顶部或者底部</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">   is at top</span></span><br><span class="line"><span class="comment">   **/</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isChildScrollToTop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (android.os.Build.VERSION.SDK_INT &lt; <span class="number">14</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span> (mTarget <span class="keyword">instanceof</span> AbsListView) &#123;</span><br><span class="line">               <span class="keyword">final</span> AbsListView absListView = (AbsListView) mTarget;</span><br><span class="line">               <span class="keyword">return</span> !(absListView.getChildCount() &gt; <span class="number">0</span> &amp;&amp; (absListView</span><br><span class="line">                       .getFirstVisiblePosition() &gt; <span class="number">0</span> || absListView</span><br><span class="line">                       .getChildAt(<span class="number">0</span>).getTop() &lt; absListView.getPaddingTop()));</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">return</span> !(mTarget.getScrollY() &gt; <span class="number">0</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">return</span> !ViewCompat.canScrollVertically(mTarget, -<span class="number">1</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">   is at bottom</span></span><br><span class="line"><span class="comment">   **/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isChildScrollToBottom</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (isChildScrollToTop()) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (mTarget <span class="keyword">instanceof</span> RecyclerView) &#123;<span class="comment">//RecyclerView</span></span><br><span class="line">           RecyclerView recyclerView = (RecyclerView) mTarget;</span><br><span class="line">           LayoutManager layoutManager = recyclerView.getLayoutManager();</span><br><span class="line">           <span class="keyword">int</span> count = recyclerView.getAdapter().getItemCount();</span><br><span class="line">           <span class="keyword">if</span> (layoutManager <span class="keyword">instanceof</span> LinearLayoutManager &amp;&amp; count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">               LinearLayoutManager linearLayoutManager = (LinearLayoutManager) layoutManager;</span><br><span class="line">               <span class="keyword">if</span> (linearLayoutManager.findLastCompletelyVisibleItemPosition() == count - <span class="number">1</span>) &#123;</span><br><span class="line">                   <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (layoutManager <span class="keyword">instanceof</span> StaggeredGridLayoutManager) &#123;</span><br><span class="line">               StaggeredGridLayoutManager staggeredGridLayoutManager = (StaggeredGridLayoutManager) layoutManager;</span><br><span class="line">               <span class="keyword">int</span>[] lastItems = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2</span>];</span><br><span class="line">               staggeredGridLayoutManager</span><br><span class="line">                       .findLastCompletelyVisibleItemPositions(lastItems);</span><br><span class="line">               <span class="keyword">int</span> lastItem = Math.max(lastItems[<span class="number">0</span>], lastItems[<span class="number">1</span>]);</span><br><span class="line">               <span class="keyword">if</span> (lastItem == count - <span class="number">1</span>) &#123;</span><br><span class="line">                   <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mTarget <span class="keyword">instanceof</span> AbsListView) &#123;</span><br><span class="line">           <span class="keyword">final</span> AbsListView absListView = (AbsListView) mTarget;</span><br><span class="line">           <span class="keyword">int</span> count = absListView.getAdapter().getCount();</span><br><span class="line">           <span class="keyword">int</span> fristPos = absListView.getFirstVisiblePosition();</span><br><span class="line">           <span class="keyword">if</span> (fristPos == <span class="number">0</span></span><br><span class="line">                   &amp;&amp; absListView.getChildAt(<span class="number">0</span>).getTop() &gt;= absListView</span><br><span class="line">                           .getPaddingTop()) &#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">int</span> lastPos = absListView.getLastVisiblePosition();</span><br><span class="line">           <span class="keyword">if</span> (lastPos &gt; <span class="number">0</span> &amp;&amp; count &gt; <span class="number">0</span> &amp;&amp; lastPos == count - <span class="number">1</span>) &#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mTarget <span class="keyword">instanceof</span> ScrollView) &#123;</span><br><span class="line">           ScrollView scrollView = (ScrollView) mTarget;</span><br><span class="line">           View view = (View) scrollView</span><br><span class="line">                   .getChildAt(scrollView.getChildCount() - <span class="number">1</span>);</span><br><span class="line">           <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="keyword">int</span> diff = (view.getBottom() - (scrollView.getHeight() + scrollView</span><br><span class="line">                       .getScrollY()));</span><br><span class="line">               <span class="keyword">if</span> (diff == <span class="number">0</span>) &#123;</span><br><span class="line">                   <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  block event</span></span><br><span class="line"><span class="comment">  **/</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onInterceptTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</span><br><span class="line"> 		......</span><br><span class="line">       <span class="keyword">if</span> (!isEnabled() || mReturningToStart || mRefreshing || mLoadMore</span><br><span class="line">               || (!isChildScrollToTop() &amp;&amp; !isChildScrollToBottom())) &#123;</span><br><span class="line">         <span class="comment">// not at top ,not at bottom,not refresh ,not loadingMore</span></span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">switch</span> (action) &#123;</span><br><span class="line">       <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">       <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">       ......</span><br><span class="line">           <span class="keyword">float</span> yDiff = <span class="number">0</span>;</span><br><span class="line">           <span class="keyword">if</span> (isChildScrollToBottom()) &#123;</span><br><span class="line">               yDiff = mInitialMotionY - y;<span class="comment">// pull distance</span></span><br><span class="line">               <span class="keyword">if</span> (yDiff &gt; mTouchSlop &amp;&amp; !mIsBeingDragged) &#123;</span><br><span class="line">                   mIsBeingDragged = <span class="keyword">true</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               yDiff = y - mInitialMotionY;<span class="comment">// push distance</span></span><br><span class="line">               <span class="keyword">if</span> (yDiff &gt; mTouchSlop &amp;&amp; !mIsBeingDragged) &#123;</span><br><span class="line">                   mIsBeingDragged = <span class="keyword">true</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">break</span>;</span><br><span class="line">	......</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> mIsBeingDragged;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">   deal with touchEvent</span></span><br><span class="line"><span class="comment">   **/</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">int</span> action = MotionEventCompat.getActionMasked(ev);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (mReturningToStart &amp;&amp; action == MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">           mReturningToStart = <span class="keyword">false</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (!isEnabled() || mReturningToStart</span><br><span class="line">               || (!isChildScrollToTop() &amp;&amp; !isChildScrollToBottom())) &#123;</span><br><span class="line">           <span class="comment">// if childView could move,do nothing</span></span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (isChildScrollToBottom()) &#123;<span class="comment">// push</span></span><br><span class="line">           <span class="keyword">return</span> handlerPushTouchEvent(ev, action);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;<span class="comment">// pull</span></span><br><span class="line">           <span class="keyword">return</span> handlerPullTouchEvent(ev, action);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h4 id="add-secondFloor"><a href="#add-secondFloor" class="headerlink" title="add secondFloor"></a>add secondFloor</h4><ol>
<li><p>abstract the headerView</p>
<p>you can add other three states in the headerView .eg:readyEnter,startEnter,endEnter.</p>
<p>And use the headerView to manager all the states.</p>
</li>
<li><p>pull Action can be separated into two states</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">handlePullTouchEvent</span><span class="params">(MotionEvent ev, <span class="keyword">int</span> action)</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">       <span class="keyword">case</span> MotionEvent.ACTION_MOVE: &#123;</span><br><span class="line"></span><br><span class="line">    	 ......</span><br><span class="line">              <span class="keyword">if</span>(mIsBeingDragged) &#123;</span><br><span class="line">                  distance = (<span class="keyword">int</span>) (distance * mDragRate);</span><br><span class="line">......</span><br><span class="line">                  <span class="keyword">if</span> (distance &lt; mTotalDragDistance) &#123;</span><br><span class="line">                      <span class="comment">// do refresh action</span></span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                 <span class="comment">//do second floor action</span></span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      ......</span><br><span class="line">          &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>​</p>
</li>
</ol>
<h4 id="ultimate-struct"><a href="#ultimate-struct" class="headerlink" title="ultimate struct"></a>ultimate struct</h4><p><img src="/images/ListView_Struct.png" alt="ListView_Struct"></p>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    Jinjian
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://jinjian.info/2017/11/04/ListView源码解读/" title="ListView源码解读">http://jinjian.info/2017/11/04/ListView源码解读/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/RTFSC-Read-the-fucking-source-code/" rel="tag"># RTFSC (Read the fucking source code )</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/10/29/TextLayoutBuilder源码解读 /" rel="next" title="TextLayoutBuilder源码解读">
                <i class="fa fa-chevron-left"></i> TextLayoutBuilder源码解读
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/11/05/ImageView源码解读/" rel="prev" title="ImageView源码解读">
                ImageView源码解读 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/my_logo.svg"
                alt="Jinjian" />
            
              <p class="site-author-name" itemprop="name">Jinjian</p>
              <p class="site-description motion-element" itemprop="description">Practice Makes Perfect</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">27</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/jinjiankla" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:jinjiankla0203@126.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://stackoverflow.com/users/8689674/user8689674" target="_blank" title="StackOverflow">
                      
                        <i class="fa fa-fw fa-stack-overflow"></i>StackOverflow</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#ListView的测量"><span class="nav-number">1.</span> <span class="nav-text">ListView的测量</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#onMeasure"><span class="nav-number">1.1.</span> <span class="nav-text">onMeasure</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#measureHeightofChildren"><span class="nav-number">1.2.</span> <span class="nav-text">measureHeightofChildren</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ListView的生成"><span class="nav-number">2.</span> <span class="nav-text">ListView的生成</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#一般流程"><span class="nav-number">2.1.</span> <span class="nav-text">一般流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#onLayout"><span class="nav-number">2.1.1.</span> <span class="nav-text">onLayout</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#layoutChildren"><span class="nav-number">2.1.2.</span> <span class="nav-text">layoutChildren</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#fillFromTop"><span class="nav-number">2.1.3.</span> <span class="nav-text">fillFromTop</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#fillDown"><span class="nav-number">2.1.4.</span> <span class="nav-text">fillDown</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#makeAndAddView"><span class="nav-number">2.1.5.</span> <span class="nav-text">makeAndAddView</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#setupChild"><span class="nav-number">2.1.6.</span> <span class="nav-text">setupChild</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#addViewInLayout"><span class="nav-number">2.1.7.</span> <span class="nav-text">addViewInLayout</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#回收机制"><span class="nav-number">2.2.</span> <span class="nav-text">回收机制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#RecycleBin"><span class="nav-number">2.2.1.</span> <span class="nav-text">RecycleBin</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#背景"><span class="nav-number">2.2.1.1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#关键参数"><span class="nav-number">2.2.1.2.</span> <span class="nav-text">关键参数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#关键方法"><span class="nav-number">2.2.1.3.</span> <span class="nav-text">关键方法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#recycle模型"><span class="nav-number">2.2.1.4.</span> <span class="nav-text">recycle模型</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#onTouchEvent事件的处理"><span class="nav-number">3.</span> <span class="nav-text">onTouchEvent事件的处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#一般流程-1"><span class="nav-number">3.1.</span> <span class="nav-text">一般流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#trackMotionScroll"><span class="nav-number">3.1.1.</span> <span class="nav-text">trackMotionScroll</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#fillGap"><span class="nav-number">3.1.2.</span> <span class="nav-text">fillGap</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#velocityTracker"><span class="nav-number">3.2.</span> <span class="nav-text">velocityTracker</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#背景-1"><span class="nav-number">3.2.1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#obtain"><span class="nav-number">3.2.2.</span> <span class="nav-text">obtain</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#computerCureentVelocity"><span class="nav-number">3.2.3.</span> <span class="nav-text">computerCureentVelocity</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GestureDetector"><span class="nav-number">3.3.</span> <span class="nav-text">GestureDetector</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#背景-2"><span class="nav-number">3.3.1.</span> <span class="nav-text">背景</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NestedScrolling"><span class="nav-number">3.4.</span> <span class="nav-text">NestedScrolling</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#背景-3"><span class="nav-number">3.4.1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#关于ListView的处理"><span class="nav-number">3.4.2.</span> <span class="nav-text">关于ListView的处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#google的再次抽象"><span class="nav-number">3.4.3.</span> <span class="nav-text">google的再次抽象</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Interpolator"><span class="nav-number">3.5.</span> <span class="nav-text">Interpolator</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#背景-4"><span class="nav-number">3.5.1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#getInterpolation"><span class="nav-number">3.5.2.</span> <span class="nav-text">getInterpolation</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ListView点击事件"><span class="nav-number">4.</span> <span class="nav-text">ListView点击事件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#为什么点击失效了"><span class="nav-number">4.1.</span> <span class="nav-text">为什么点击失效了</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#焦点管理"><span class="nav-number">4.1.0.1.</span> <span class="nav-text">焦点管理</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#requestFocusNoSearch"><span class="nav-number">4.1.0.2.</span> <span class="nav-text">requestFocusNoSearch</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#handleFocusGainInternal"><span class="nav-number">4.1.0.3.</span> <span class="nav-text">handleFocusGainInternal</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#处理流程"><span class="nav-number">4.1.0.4.</span> <span class="nav-text">处理流程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#onTouchUp"><span class="nav-number">4.1.0.5.</span> <span class="nav-text">onTouchUp</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#扩展功能"><span class="nav-number">5.</span> <span class="nav-text">扩展功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#阻尼效果"><span class="nav-number">5.1.</span> <span class="nav-text">阻尼效果</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#背景-5"><span class="nav-number">5.1.1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#How-to-Invoke"><span class="nav-number">5.1.2.</span> <span class="nav-text">How to Invoke</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#overScrollBy"><span class="nav-number">5.1.3.</span> <span class="nav-text">overScrollBy</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Android的原生阻尼"><span class="nav-number">5.1.4.</span> <span class="nav-text">Android的原生阻尼</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#EdgeEeffect"><span class="nav-number">5.1.4.1.</span> <span class="nav-text">EdgeEeffect</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SwipeRefreshLayout下拉刷新-上拉加载更多"><span class="nav-number">5.2.</span> <span class="nav-text">SwipeRefreshLayout下拉刷新/上拉加载更多</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#how-to-create"><span class="nav-number">5.2.1.</span> <span class="nav-text">how to create</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#contruction"><span class="nav-number">5.2.1.1.</span> <span class="nav-text">contruction</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#onMeasure-1"><span class="nav-number">5.2.1.2.</span> <span class="nav-text">onMeasure</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#onLayout-1"><span class="nav-number">5.2.1.3.</span> <span class="nav-text">onLayout</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#touchEvent-amp-amp-stateChange"><span class="nav-number">5.2.2.</span> <span class="nav-text">touchEvent&amp;&amp;stateChange</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#onInterceptTouchEvent"><span class="nav-number">5.2.2.1.</span> <span class="nav-text">onInterceptTouchEvent</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#onTouchEvent"><span class="nav-number">5.2.2.2.</span> <span class="nav-text">onTouchEvent</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#add-header-and-footer-yourself"><span class="nav-number">5.2.3.</span> <span class="nav-text">add header and footer yourself</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#construction"><span class="nav-number">5.2.3.1.</span> <span class="nav-text">construction</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#onMeasure-2"><span class="nav-number">5.2.3.2.</span> <span class="nav-text">onMeasure</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#onLayout-2"><span class="nav-number">5.2.3.3.</span> <span class="nav-text">onLayout</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#notify-pull-and-push-Action"><span class="nav-number">5.2.3.4.</span> <span class="nav-text">notify pull and push Action</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#add-secondFloor"><span class="nav-number">5.2.4.</span> <span class="nav-text">add secondFloor</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ultimate-struct"><span class="nav-number">5.2.5.</span> <span class="nav-text">ultimate struct</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jinjian</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        

  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ddb5ad830b0accecaab2b551afd8c824";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
